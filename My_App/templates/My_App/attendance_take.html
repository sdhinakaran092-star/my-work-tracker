{% extends "base.html" %}

{% block title %}Take Attendance | My Work Tracker{% endblock %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Take Attendance</h1>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'attendance_history' %}">History</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <p class="text-secondary mb-3">Choose your attendance for today.</p>

      <div class="d-flex flex-wrap gap-2">
        <button id="presentBtn" type="button" class="btn btn-success">Present</button>
        <button id="absentBtn" type="button" class="btn btn-danger">Absent</button>
      </div>

      <div id="cameraWrap" class="mt-3" style="display:none;">
        <div class="text-secondary small mb-2">Opening camera and capturing photo…</div>
        <video id="video" class="w-100 rounded border" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>

      <div id="statusMsg" class="mt-3"></div>

      <noscript>
        <div class="alert alert-warning mt-3" role="alert">
          JavaScript is required to take Present attendance with a photo.
        </div>
      </noscript>
    </div>
  </div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    const presentBtn = document.getElementById('presentBtn');
    const absentBtn = document.getElementById('absentBtn');
    const cameraWrap = document.getElementById('cameraWrap');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const statusMsg = document.getElementById('statusMsg');

    function setBusy(isBusy) {
      presentBtn.disabled = isBusy;
      absentBtn.disabled = isBusy;
    }

    function showAlert(kind, text) {
      statusMsg.innerHTML = `<div class="alert alert-${kind}" role="alert">${text}</div>`;
    }

    async function postAttendance(formData) {
      const csrfToken = getCookie('csrftoken');
      const resp = await fetch('', {
        method: 'POST',
        headers: { 'X-CSRFToken': csrfToken },
        body: formData,
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok) {
        throw new Error(data.error || 'Failed to save attendance');
      }

      if (data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        window.location.href = '{% url "attendance_history" %}';
      }
    }

    absentBtn.addEventListener('click', async () => {
      try {
        setBusy(true);
        showAlert('info', 'Saving Absent…');
        const formData = new FormData();
        formData.append('status', 'Absent');
        await postAttendance(formData);
      } catch (err) {
        setBusy(false);
        showAlert('danger', err.message);
      }
    });

    presentBtn.addEventListener('click', async () => {
      let stream;
      try {
        setBusy(true);
        cameraWrap.style.display = 'block';
        showAlert('info', 'Opening camera…');

        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        video.srcObject = stream;

        await new Promise((resolve) => {
          video.onloadedmetadata = () => resolve();
        });
        await video.play();

        // Give the camera a moment to adjust exposure.
        await new Promise((r) => setTimeout(r, 700));

        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', 0.9));
        if (!blob) throw new Error('Could not capture photo');

        showAlert('info', 'Saving Present…');
        const formData = new FormData();
        formData.append('status', 'Present');
        formData.append('photo', blob, 'attendance.jpg');

        await postAttendance(formData);
      } catch (err) {
        setBusy(false);
        showAlert('danger', err.message);
      } finally {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
        }
      }
    });
  </script>
{% endblock %}
